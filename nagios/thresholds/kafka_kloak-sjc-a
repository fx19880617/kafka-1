# vim: set ft=python
boxes = 'kloak{01,02,03,04,05,06,07,08}-sjc1'

warn_thresholds = {

    'absolute_cluster_wait_time' : 60,
}

critical_thresholds = {
    'leaderelection_alert' : 0,
    'controller_count_bug' : 1,

    #If we have more than 3 (averaged out across the cluster) under replicated partition in 1 minute for continuous 15 minutes we alert.
    #this is subjected to change after we monitor for sometime.
    'cluster_under_replication' : 0.05,

    'absolute_cluster_io_wait_time' : 70,

    #disk full alert is set at 1.4 TB
    'disk_full_alert' : 1400000000000,

    #isr alert 
    'isr_expand_alert' : 0,
    'isr_shrink_alert' : 0,
  
}

checks = {

   'controller_count_bug': 'sumSeries(servers.' + boxes + '.kafka.controller.KafkaController.ActiveControllerCount.value)',
   'leaderelection_alert' : 'sumSeries(servers.' + boxes + '.kafka.controller.ControllerStats.LeaderElectionRateAndTimeMs.1MinuteRate)',

    #cluster wide under replication 
   'cluster_under_replication' : 'movingAverage(averageSeries(servers.' + boxes + '.kafka.server.ReplicaManager.UnderReplicatedPartitions.value),"15min")',

    #absolute IO wait time for the cluster
   'absolute_cluster_io_wait_time' : 'movingAverage(averageSeries(servers.' + boxes + '.disk.sda.await),"30min")',

    #disk full alert
    'disk_full_alert' : 'averageSeries(servers.' + boxes + '.disk.internal-root.used_bytes)',

    #per topic mean rate: leaving it for now as part of the scala project
    
    #ISR expands per sec across cluster. Subjected to change after monitoring
    'isr_expand_alert' : 'movingAverage(averageSeries(servers.' + boxes + '.kafka.server.ReplicaManager.IsrExpandsPerSec.meanRate),"5min")',

    #ISR shrinks per sec across cluster. Subjected to change after monitoring
    'isr_shrink_alert' : 'movingAverage(averageSeries(servers.' + boxes + '.kafka.server.ReplicaManager.IsrShrinksPerSec.meanRate),"5min")',

}

for check in checks:
    
    graphite.absolute_threshold(checks[check], alias=check, warning_over=warn_thresholds.get(check), critical_over=critical_thresholds.get(check))

#if the disk wait increases 2x within 30 minutes time frame alert
graphite.relative_threshold('movingAverage(averageSeries(servers.' + boxes + '.disk.sda.await),"30min")', '-30min', warning_over=2.0, critical_over=2.5)
