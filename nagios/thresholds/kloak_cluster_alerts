# vim: set ft=python
boxes = 'kloak*-sjc1'

warn_thresholds = {
    'absolute_cluster_io_wait_time' : 60,
}

critical_thresholds = {
    'leaderelection_alert' : 0,
    'cluster_under_replication' : 0.05,
    'absolute_cluster_io_wait_time' : 70,
    'isr_expand_alert' : 0,
    'isr_shrink_alert' : 0,
}

checks = {
    'leaderelection_alert' : 'sumSeries(servers.' + boxes + '.kafka.controller.ControllerStats.LeaderElectionRateAndTimeMs.1MinuteRate)',
    'cluster_under_replication' : 'movingAverage(averageSeries(servers.' + boxes + '.kafka.server.ReplicaManager.UnderReplicatedPartitions.value),"15min")',
    'absolute_cluster_io_wait_time' : 'movingAverage(averageSeries(servers.' + boxes + '.disk.sda.await),"30min")',
    'isr_expand_alert' : 'movingAverage(averageSeries(servers.' + boxes + '.kafka.server.ReplicaManager.IsrExpandsPerSec.meanRate),"5min")',
    'isr_shrink_alert' : 'movingAverage(averageSeries(servers.' + boxes + '.kafka.server.ReplicaManager.IsrShrinksPerSec.meanRate),"5min")',
}

for check in checks:

    graphite.absolute_threshold(checks[check], alias=check, warning_over=warn_thresholds.get(check), critical_over=critical_thresholds.get(check))

graphite.relative_threshold('movingAverage(averageSeries(servers.' + boxes + '.disk.sda.await),"30min")', '-1d', warning_over=3.0, critical_over=4)
