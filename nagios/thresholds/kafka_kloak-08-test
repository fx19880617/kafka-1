# vim: set ft=python
boxes = 'kloak{01,02,03,04,05,06,07,08}-sjc1'

warn_thresholds = {

    'absolute_cluster_wait_time' : 60,
}

critical_thresholds = {
    'leaderelection_alert' : 0,
    'controller_count_bug' : 1,
    #for now alerting if the moving average in 15 mins is > 0.0011. If we have more than 1 under replicated partition in 15 mins we alert.
    #this is subjected to change after we monitor for sometime.
    'under_replication_kloak01' : 0.0011,
    'under_replication_kloak02' : 0.0011,
    'under_replication_kloak03' : 0.0011,
    'under_replication_kloak04' : 0.0011,
    'under_replication_kloak05' : 0.0011,
    'under_replication_kloak06' : 0.0011,
    'under_replication_kloak07' : 0.0011,
    'under_replication_kloak08' : 0.0011,

    'absolute_cluster_wait_time' : 70,
}

checks = {

   'controller_count_bug': 'sumSeries(servers.' + boxes + '.kafka.controller.KafkaController.ActiveControllerCount.value)',
   'leaderelection_alert' : 'sumSeries(servers.' + boxes + '.kafka.controller.ControllerStats.LeaderElectionRateAndTimeMs.1MinuteRate)',

   #under replication thresholds
   'under_replication_kloak01' : 'movingAverage(servers.kloak01-sjc1.kafka.server.ReplicaManager.UnderReplicatedPartitions.value,"15min")',
   'under_replication_kloak02' : 'movingAverage(servers.kloak02-sjc1.kafka.server.ReplicaManager.UnderReplicatedPartitions.value,"15min")',
   'under_replication_kloak03' : 'movingAverage(servers.kloak03-sjc1.kafka.server.ReplicaManager.UnderReplicatedPartitions.value,"15min")',
   'under_replication_kloak04' : 'movingAverage(servers.kloak04-sjc1.kafka.server.ReplicaManager.UnderReplicatedPartitions.value,"15min")',
   'under_replication_kloak05' : 'movingAverage(servers.kloak05-sjc1.kafka.server.ReplicaManager.UnderReplicatedPartitions.value,"15min")',
   'under_replication_kloak06' : 'movingAverage(servers.kloak06-sjc1.kafka.server.ReplicaManager.UnderReplicatedPartitions.value,"15min")',
   'under_replication_kloak07' : 'movingAverage(servers.kloak07-sjc1.kafka.server.ReplicaManager.UnderReplicatedPartitions.value,"15min")',
   'under_replication_kloak08' : 'movingAverage(servers.kloak08-sjc1.kafka.server.ReplicaManager.UnderReplicatedPartitions.value,"15min")',

   #absolute IO wait time for the cluster
   'absolute_cluster_wait_time' : 'movingAverage(averageSeries(servers.' + boxes + '.disk.sda.await),"30min")',


}

for check in checks:
    
    graphite.absolute_threshold(checks[check], alias=check, warning_over=warn_thresholds.get(check), critical_over=critical_thresholds.get(check))

graphite.relative_threshold('movingAverage(averageSeries(servers.' + boxes + '.disk.sda.await),"30min")', '-30min', warning_over=2.0, critical_over=2.5)
